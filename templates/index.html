<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutual Fund Returns Tracker</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">

    <!-- Modern Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top py-1">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Mutual Fund Returns Tracker</a>
            <div class="d-flex align-items-center">
                <span class="navbar-text me-3">
                    Last Updated: {{ last_updated }}
                </span>
                <button class="btn btn-outline-light btn-sm refresh-btn" id="refreshBtn" title="Refresh Data">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-3" style="margin-top:4rem;">
        <!-- View Toggle and Expand/Collapse Buttons -->
        <div class="card shadow-sm mb-3">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="viewMode" id="tableView" autocomplete="off" checked>
                        <label class="btn btn-outline-primary btn-sm" for="tableView">
                            <i class="bi bi-table me-1"></i>Table View
                        </label>
                        <input type="radio" class="btn-check" name="viewMode" id="comparisonView" autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="comparisonView">
                            <i class="bi bi-grid-3x3-gap me-1"></i>Comparison Matrix
                        </label>
                    </div>
                    <div class="btn-group" role="group" id="expandCollapseButtons">
                        <button class="btn btn-outline-secondary btn-sm" id="expandAllBtn">
                            <i class="bi bi-chevron-double-down me-1"></i>Expand All
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="collapseAllBtn">
                            <i class="bi bi-chevron-double-up me-1"></i>Collapse All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table View -->
        <div class="card shadow-sm" id="tableViewContainer">
            <div class="table-wrapper card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped align-middle" id="fundTable">
                        <thead class="table-light">
                            <tr>
                                <th class="fund-name-column">Fund Name</th>
                                <th class="amfi-code-column">AMFI Code</th>
                                <th class="nav-column">Current NAV<br><small class="text-muted">({{
                                        funds[0].current_date }})</small></th>
                                <th class="returns-column sortable" data-sort="1day">1 Day <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['1day'] }})</small></th>
                                <th class="returns-column sortable" data-sort="1week">1 Week <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['1week'] }})</small></th>
                                <th class="returns-column sortable" data-sort="1month">1 Month <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['1month'] }})</small></th>
                                <th class="returns-column sortable d-none d-md-table-cell" data-sort="3month">3 Months
                                    <i class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['3month'] }})</small>
                                </th>
                                <th class="returns-column sortable d-none d-md-table-cell" data-sort="6month">6 Months
                                    <i class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['6month'] }})</small>
                                </th>
                                <th class="returns-column sortable" data-sort="1year">1 Year <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['1year'] }})</small></th>
                                <th class="returns-column sortable" data-sort="2year">2 Years <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['2year'] }})</small></th>
                                <th class="returns-column sortable" data-sort="3year">3 Years <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['3year'] }})</small></th>
                                <th class="returns-column sortable" data-sort="5year">5 Years <i
                                        class="bi bi-arrow-down-up"></i><br><small class="text-muted">({{
                                        funds[0].dates['5year'] }})</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fund in funds %}
                            <!-- Main row - clickable -->
                            <tr class="fund-row clickable-row" data-bs-toggle="collapse"
                                data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false"
                                style="cursor: pointer;">
                                <td class="fund-name-cell">
                                    <i class="bi bi-chevron-right accordion-icon me-2"></i>
                                    <span class="fund-name">{{ fund.name }}</span>
                                </td>
                                <td>
                                    <span class="amfi-code">{{ fund.code }}</span>
                                </td>
                                <td>
                                    <span class="current-nav-value">₹{{ fund.current_nav }}</span>
                                </td>
                                <td class="{% if fund.returns['1day'] == 0 %}text-muted{% elif fund.returns['1day'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['1day'] }}">
                                    {% if fund.returns['1day'] == 0 %}NA{% else %}{{ "%.2f"|format(fund.returns['1day'])
                                    }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['1week'] == 0 %}text-muted{% elif fund.returns['1week'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['1week'] }}">
                                    {% if fund.returns['1week'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['1week']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['1month'] == 0 %}text-muted{% elif fund.returns['1month'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['1month'] }}">
                                    {% if fund.returns['1month'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['1month']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['3month'] == 0 %}text-muted{% elif fund.returns['3month'] < 0 %}text-danger{% else %}text-success{% endif %} d-none d-md-table-cell"
                                    data-value="{{ fund.returns['3month'] }}">
                                    {% if fund.returns['3month'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['3month']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['6month'] == 0 %}text-muted{% elif fund.returns['6month'] < 0 %}text-danger{% else %}text-success{% endif %} d-none d-md-table-cell"
                                    data-value="{{ fund.returns['6month'] }}">
                                    {% if fund.returns['6month'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['6month']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['1year'] == 0 %}text-muted{% elif fund.returns['1year'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['1year'] }}">
                                    {% if fund.returns['1year'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['1year']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['2year'] == 0 %}text-muted{% elif fund.returns['2year'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['2year'] }}">
                                    {% if fund.returns['2year'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['2year']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['3year'] == 0 %}text-muted{% elif fund.returns['3year'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['3year'] }}">
                                    {% if fund.returns['3year'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['3year']) }}%{% endif %}
                                </td>
                                <td class="{% if fund.returns['5year'] == 0 %}text-muted{% elif fund.returns['5year'] < 0 %}text-danger{% else %}text-success{% endif %}"
                                    data-value="{{ fund.returns['5year'] }}">
                                    {% if fund.returns['5year'] == 0 %}NA{% else %}{{
                                    "%.2f"|format(fund.returns['5year']) }}%{% endif %}
                                </td>
                            </tr>

                            <!-- Expanded accordion row -->
                            <tr class="collapse accordion-collapse" id="collapse-{{ loop.index }}">
                                <td colspan="11" class="accordion-body-cell">
                                    <div class="accordion-content p-4 bg-light">
                                        <h6 class="mb-3 text-primary"><i class="bi bi-graph-up me-2"></i>Complete
                                            Returns Analysis</h6>

                                        {% if fund.year_breakdown and (fund.year_breakdown.get('2year') or
                                        fund.year_breakdown.get('3year') or fund.year_breakdown.get('5year')) %}
                                        <div class="card shadow-sm">
                                            <div class="card-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-sm mb-0">
                                                        <thead class="table-primary">
                                                            <tr>
                                                                <th style="width: 45%;">Period</th>
                                                                <th class="text-end" style="width: 20%;">Return %</th>
                                                                <th class="text-end" style="width: 20%;">Total Absolute
                                                                </th>
                                                                <th class="text-end" style="width: 15%;">CAGR</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% if fund.year_breakdown.get('5year') and
                                                            fund.year_breakdown['5year'].get('year_dates') %}
                                                            <tr class="table-light">
                                                                <td><strong>Year 1</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['5year']['year_dates']['year1_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['5year']['year_dates']['year1_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['5year']['year1'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['5year']['year1'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['5year']['year1'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 2</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['5year']['year_dates']['year2_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['5year']['year_dates']['year2_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['5year']['year2'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['5year']['year2'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['5year']['year2'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 3</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['5year']['year_dates']['year3_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['5year']['year_dates']['year3_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['5year']['year3'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['5year']['year3'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['5year']['year3'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 4</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['5year']['year_dates']['year4_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['5year']['year_dates']['year4_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['5year']['year4'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['5year']['year4'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['5year']['year4'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 5</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['5year']['year_dates']['year5_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['5year']['year_dates']['year5_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['5year']['year5'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['5year']['year5'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['5year']['year5'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            {% elif fund.year_breakdown.get('3year') and
                                                            fund.year_breakdown['3year'].get('year_dates') %}
                                                            <tr class="table-light">
                                                                <td><strong>Year 1</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['3year']['year_dates']['year1_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['3year']['year_dates']['year1_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['3year']['year1'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['3year']['year1'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['3year']['year1'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 2</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['3year']['year_dates']['year2_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['3year']['year_dates']['year2_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['3year']['year2'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['3year']['year2'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['3year']['year2'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 3</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['3year']['year_dates']['year3_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['3year']['year_dates']['year3_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['3year']['year3'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['3year']['year3'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['3year']['year3'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            {% elif fund.year_breakdown.get('2year') and
                                                            fund.year_breakdown['2year'].get('year_dates') %}
                                                            <tr class="table-light">
                                                                <td><strong>Year 1</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['2year']['year_dates']['year1_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['2year']['year_dates']['year1_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['2year']['year1'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['2year']['year1'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['2year']['year1'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            <tr class="table-light">
                                                                <td><strong>Year 2</strong> <small
                                                                        class="text-muted">({{
                                                                        fund.year_breakdown['2year']['year_dates']['year2_start']
                                                                        }} to {{
                                                                        fund.year_breakdown['2year']['year_dates']['year2_end']
                                                                        }})</small></td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['2year']['year2'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}">
                                                                    {% if fund.year_breakdown['2year']['year2'] >= 0
                                                                    %}<i class="bi bi-arrow-up-circle-fill me-1"></i>{%
                                                                    else %}<i
                                                                        class="bi bi-arrow-down-circle-fill me-1"></i>{%
                                                                    endif %}
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['2year']['year2'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td class="text-end text-muted">—</td>
                                                            </tr>
                                                            {% endif %}

                                                            <!-- Multi-Year Summary in same table -->
                                                            <tr class="table-secondary">
                                                                <td colspan="4" class="text-center fw-bold"><i
                                                                        class="bi bi-calculator me-2"></i>MULTI-YEAR
                                                                    SUMMARY</td>
                                                            </tr>

                                                            {% if fund.year_breakdown.get('2year') %}
                                                            <tr class="table-info">
                                                                <td><strong class="text-primary">2-Year Period</strong>
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['2year']['total_absolute'] >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold fs-6">
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['2year']['total_absolute'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-secondary fw-bold">{{
                                                                    "%.2f"|format(fund.returns['2year']) }}%</td>
                                                            </tr>
                                                            {% endif %}

                                                            {% if fund.year_breakdown.get('3year') %}
                                                            <tr class="table-success">
                                                                <td><strong class="text-success">3-Year Period</strong>
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['3year']['total_absolute'] >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold fs-6">
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['3year']['total_absolute'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-secondary fw-bold">{{
                                                                    "%.2f"|format(fund.returns['3year']) }}%</td>
                                                            </tr>
                                                            {% endif %}

                                                            {% if fund.year_breakdown.get('5year') %}
                                                            <tr class="table-warning">
                                                                <td><strong class="text-info">5-Year Period</strong>
                                                                </td>
                                                                <td class="text-end text-muted">—</td>
                                                                <td
                                                                    class="text-end {% if fund.year_breakdown['5year']['total_absolute'] >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold fs-6">
                                                                    {{
                                                                    "%.2f"|format(fund.year_breakdown['5year']['total_absolute'])
                                                                    }}%
                                                                </td>
                                                                <td class="text-end text-secondary fw-bold">{{
                                                                    "%.2f"|format(fund.returns['5year']) }}%</td>
                                                            </tr>
                                                            {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info mb-0">
                                            <i class="bi bi-info-circle me-2"></i>Year-by-year breakdown not available
                                            for this fund.
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Comparison Matrix View (Hidden by default) -->
        <div class="card shadow-sm" id="comparisonViewContainer" style="display: none;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-grid-3x3-gap me-2"></i>Comparison Matrix</h5>
            </div>
            <div class="card-body p-0">
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs nav-fill" id="comparisonTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="shortTermTab" data-bs-toggle="tab"
                            data-bs-target="#shortTermPane" type="button">
                            <i class="bi bi-clock-history me-1"></i>Short-term (1D - 1Y)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="yearlyTab" data-bs-toggle="tab" data-bs-target="#yearlyPane"
                            type="button">
                            <i class="bi bi-calendar-range me-1"></i>Year-by-Year (Y1-Y5)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="summaryTab" data-bs-toggle="tab" data-bs-target="#summaryPane"
                            type="button">
                            <i class="bi bi-calculator me-1"></i>Multi-Year Summary
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content p-3" id="comparisonTabContent">
                    <!-- Tab 1: Short-term Performance -->
                    <div class="tab-pane fade show active" id="shortTermPane">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered mb-0" id="shortTermTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="sticky-start bg-white sortable-header" data-column="0"
                                            style="cursor: pointer;">
                                            Fund Name <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-end sortable-header" data-column="1" style="cursor: pointer;">
                                            <div>1 Day <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{ funds[0].dates['1day'] }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="2" style="cursor: pointer;">
                                            <div>1 Week <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{ funds[0].dates['1week'] }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="3" style="cursor: pointer;">
                                            <div>1 Month <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{ funds[0].dates['1month'] }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="4" style="cursor: pointer;">
                                            <div>3 Months <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{ funds[0].dates['3month'] }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="5" style="cursor: pointer;">
                                            <div>6 Months <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{ funds[0].dates['6month'] }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="6" style="cursor: pointer;">
                                            <div>1 Year <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{ funds[0].dates['1year'] }})</small>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fund in funds %}
                                    <tr>
                                        <td class="sticky-start bg-white" data-value="{{ fund.name }}"><strong>{{
                                                fund.name }}</strong></td>
                                        <td class="text-end {% if fund.returns['1day'] >= 0 %}text-success{% else %}text-danger{% endif %}"
                                            data-value="{{ fund.returns['1day'] }}">
                                            {{ "%.2f"|format(fund.returns['1day']) }}%
                                        </td>
                                        <td class="text-end {% if fund.returns['1week'] >= 0 %}text-success{% else %}text-danger{% endif %}"
                                            data-value="{{ fund.returns['1week'] }}">
                                            {{ "%.2f"|format(fund.returns['1week']) }}%
                                        </td>
                                        <td class="text-end {% if fund.returns['1month'] >= 0 %}text-success{% else %}text-danger{% endif %}"
                                            data-value="{{ fund.returns['1month'] }}">
                                            {{ "%.2f"|format(fund.returns['1month']) }}%
                                        </td>
                                        <td class="text-end {% if fund.returns['3month'] >= 0 %}text-success{% else %}text-danger{% endif %}"
                                            data-value="{{ fund.returns['3month'] }}">
                                            {{ "%.2f"|format(fund.returns['3month']) }}%
                                        </td>
                                        <td class="text-end {% if fund.returns['6month'] >= 0 %}text-success{% else %}text-danger{% endif %}"
                                            data-value="{{ fund.returns['6month'] }}">
                                            {{ "%.2f"|format(fund.returns['6month']) }}%
                                        </td>
                                        <td class="text-end {% if fund.returns['1year'] >= 0 %}text-success{% else %}text-danger{% endif %}"
                                            data-value="{{ fund.returns['1year'] }}">
                                            {{ "%.2f"|format(fund.returns['1year']) }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab 2: Year-by-Year Returns -->
                    <div class="tab-pane fade" id="yearlyPane">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered mb-0" id="yearlyTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="sticky-start bg-white sortable-header" data-column="0"
                                            style="cursor: pointer;">
                                            Fund Name <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        {% set first_fund_with_data =
                                        funds|selectattr('year_breakdown.5year.year_dates', 'defined')|first %}
                                        {% if first_fund_with_data %}
                                        <th class="text-end sortable-header" data-column="1" style="cursor: pointer;">
                                            <div>Year 1 <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year1_start']
                                                }} to {{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year1_end']
                                                }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="2" style="cursor: pointer;">
                                            <div>Year 2 <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year2_start']
                                                }} to {{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year2_end']
                                                }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="3" style="cursor: pointer;">
                                            <div>Year 3 <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year3_start']
                                                }} to {{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year3_end']
                                                }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="4" style="cursor: pointer;">
                                            <div>Year 4 <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year4_start']
                                                }} to {{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year4_end']
                                                }})</small>
                                        </th>
                                        <th class="text-end sortable-header" data-column="5" style="cursor: pointer;">
                                            <div>Year 5 <i class="bi bi-arrow-down-up"></i></div>
                                            <small class="text-muted">({{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year5_start']
                                                }} to {{
                                                first_fund_with_data.year_breakdown['5year']['year_dates']['year5_end']
                                                }})</small>
                                        </th>
                                        {% else %}
                                        <th class="text-end sortable-header" data-column="1" style="cursor: pointer;">
                                            Year 1 <i class="bi bi-arrow-down-up"></i></th>
                                        <th class="text-end sortable-header" data-column="2" style="cursor: pointer;">
                                            Year 2 <i class="bi bi-arrow-down-up"></i></th>
                                        <th class="text-end sortable-header" data-column="3" style="cursor: pointer;">
                                            Year 3 <i class="bi bi-arrow-down-up"></i></th>
                                        <th class="text-end sortable-header" data-column="4" style="cursor: pointer;">
                                            Year 4 <i class="bi bi-arrow-down-up"></i></th>
                                        <th class="text-end sortable-header" data-column="5" style="cursor: pointer;">
                                            Year 5 <i class="bi bi-arrow-down-up"></i></th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fund in funds %}
                                    <tr>
                                        <td class="sticky-start bg-white" data-value="{{ fund.name }}"><strong>{{
                                                fund.name }}</strong></td>
                                        {% if fund.year_breakdown.get('5year') %}
                                        <td class="text-end {% if fund.year_breakdown['5year']['year1'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}"
                                            data-value="{{ fund.year_breakdown['5year']['year1'] }}">
                                            {{ "%.2f"|format(fund.year_breakdown['5year']['year1']) }}%
                                        </td>
                                        <td class="text-end {% if fund.year_breakdown['5year']['year2'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}"
                                            data-value="{{ fund.year_breakdown['5year']['year2'] }}">
                                            {{ "%.2f"|format(fund.year_breakdown['5year']['year2']) }}%
                                        </td>
                                        <td class="text-end {% if fund.year_breakdown['5year']['year3'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}"
                                            data-value="{{ fund.year_breakdown['5year']['year3'] }}">
                                            {{ "%.2f"|format(fund.year_breakdown['5year']['year3']) }}%
                                        </td>
                                        <td class="text-end {% if fund.year_breakdown['5year']['year4'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}"
                                            data-value="{{ fund.year_breakdown['5year']['year4'] }}">
                                            {{ "%.2f"|format(fund.year_breakdown['5year']['year4']) }}%
                                        </td>
                                        <td class="text-end {% if fund.year_breakdown['5year']['year5'] >= 0 %}text-success fw-bold{% else %}text-danger fw-bold{% endif %}"
                                            data-value="{{ fund.year_breakdown['5year']['year5'] }}">
                                            {{ "%.2f"|format(fund.year_breakdown['5year']['year5']) }}%
                                        </td>
                                        {% else %}
                                        <td class="text-end text-muted" colspan="5" data-value="0">Data not available
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Tab 3: Multi-Year Summary -->
                    <div class="tab-pane fade" id="summaryPane">
                        <!-- Year Selection Controls -->
                        <div class="card mb-3 bg-light">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="me-3"><i class="bi bi-funnel me-2"></i>Include Years:</strong>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input year-filter" type="checkbox"
                                                id="includeYear1" value="1" checked>
                                            <label class="form-check-label" for="includeYear1">Year 1</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input year-filter" type="checkbox"
                                                id="includeYear2" value="2" checked>
                                            <label class="form-check-label" for="includeYear2">Year 2</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input year-filter" type="checkbox"
                                                id="includeYear3" value="3" checked>
                                            <label class="form-check-label" for="includeYear3">Year 3</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input year-filter" type="checkbox"
                                                id="includeYear4" value="4" checked>
                                            <label class="form-check-label" for="includeYear4">Year 4</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input year-filter" type="checkbox"
                                                id="includeYear5" value="5" checked>
                                            <label class="form-check-label" for="includeYear5">Year 5</label>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-secondary" id="resetYearsBtn">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i>Reset All
                                    </button>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>Uncheck outlier years to recalculate
                                        returns without them
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm table-hover table-bordered mb-0" id="summaryTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="sticky-start bg-white sortable-header" rowspan="2" data-column="0"
                                            style="cursor: pointer;">
                                            Fund Name <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-center bg-info text-white" colspan="2">2-Year Period</th>
                                        <th class="text-center bg-success text-white" colspan="2">3-Year Period</th>
                                        <th class="text-center bg-warning" colspan="2">5-Year Period</th>
                                    </tr>
                                    <tr>
                                        <th class="text-end bg-light sortable-header" data-column="1"
                                            style="cursor: pointer;">
                                            Total Absolute <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-end bg-light sortable-header" data-column="2"
                                            style="cursor: pointer;">
                                            CAGR <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-end bg-light sortable-header" data-column="3"
                                            style="cursor: pointer;">
                                            Total Absolute <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-end bg-light sortable-header" data-column="4"
                                            style="cursor: pointer;">
                                            CAGR <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-end bg-light sortable-header" data-column="5"
                                            style="cursor: pointer;">
                                            Total Absolute <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                        <th class="text-end bg-light sortable-header" data-column="6"
                                            style="cursor: pointer;">
                                            CAGR <i class="bi bi-arrow-down-up"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fund in funds %}
                                    <tr>
                                        <td class="sticky-start bg-white" data-value="{{ fund.name }}"><strong>{{
                                                fund.name }}</strong></td>
                                        {% if fund.year_breakdown.get('5year') %}
                                        <td class="text-end total-abs-2y"
                                            data-value="{{ fund.year_breakdown['2year']['total_absolute'] if fund.year_breakdown.get('2year') else 0 }}"
                                            data-y1="{{ fund.year_breakdown['5year']['year4'] }}"
                                            data-y2="{{ fund.year_breakdown['5year']['year5'] }}">
                                            <span
                                                class="{% if fund.year_breakdown.get('2year') and fund.year_breakdown['2year']['total_absolute'] >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                {{ "%.2f"|format(fund.year_breakdown['2year']['total_absolute']) if
                                                fund.year_breakdown.get('2year') else '—' }}%
                                            </span>
                                        </td>
                                        <td class="text-end cagr-2y text-secondary"
                                            data-value="{{ fund.returns['2year'] if fund.year_breakdown.get('2year') else 0 }}">
                                            {{ "%.2f"|format(fund.returns['2year']) if fund.year_breakdown.get('2year')
                                            else '—' }}%
                                        </td>

                                        <td class="text-end total-abs-3y"
                                            data-value="{{ fund.year_breakdown['3year']['total_absolute'] if fund.year_breakdown.get('3year') else 0 }}"
                                            data-y1="{{ fund.year_breakdown['5year']['year3'] }}"
                                            data-y2="{{ fund.year_breakdown['5year']['year4'] }}"
                                            data-y3="{{ fund.year_breakdown['5year']['year5'] }}">
                                            <span
                                                class="{% if fund.year_breakdown.get('3year') and fund.year_breakdown['3year']['total_absolute'] >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                {{ "%.2f"|format(fund.year_breakdown['3year']['total_absolute']) if
                                                fund.year_breakdown.get('3year') else '—' }}%
                                            </span>
                                        </td>
                                        <td class="text-end cagr-3y text-secondary"
                                            data-value="{{ fund.returns['3year'] if fund.year_breakdown.get('3year') else 0 }}">
                                            {{ "%.2f"|format(fund.returns['3year']) if fund.year_breakdown.get('3year')
                                            else '—' }}%
                                        </td>

                                        <td class="text-end total-abs-5y"
                                            data-value="{{ fund.year_breakdown['5year']['total_absolute'] }}"
                                            data-y1="{{ fund.year_breakdown['5year']['year1'] }}"
                                            data-y2="{{ fund.year_breakdown['5year']['year2'] }}"
                                            data-y3="{{ fund.year_breakdown['5year']['year3'] }}"
                                            data-y4="{{ fund.year_breakdown['5year']['year4'] }}"
                                            data-y5="{{ fund.year_breakdown['5year']['year5'] }}">
                                            <span
                                                class="{% if fund.year_breakdown['5year']['total_absolute'] >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                {{ "%.2f"|format(fund.year_breakdown['5year']['total_absolute']) }}%
                                            </span>
                                        </td>
                                        <td class="text-end cagr-5y text-secondary"
                                            data-value="{{ fund.returns['5year'] }}">
                                            {{ "%.2f"|format(fund.returns['5year']) }}%
                                        </td>
                                        {% else %}
                                        <td class="text-end text-muted" data-value="0" colspan="6">Data not available
                                        </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-3 mt-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Notes</h5>
            </div>
            <div class="card-body">
                <form id="noteForm">
                    <div class="mb-3">
                        <label for="noteDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="noteDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="noteText" class="form-label">Note</label>
                        <textarea class="form-control" id="noteText" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Note</button>
                </form>
                <hr>
                <h6>Saved Notes</h6>
                <ul id="notesList" class="list-group">
                    <!-- Notes will be added here dynamically -->
                </ul>
            </div>
        </div>
    </div>

    <footer class="footer mt-5 py-3 bg-white">
        <div class="container text-center">
            <small class="text-muted">Data sourced from AMFI India | {{ fund_count }} funds loaded</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Performance optimizations
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // Cache DOM elements
        const table = document.getElementById('fundTable');
        const headers = table.querySelectorAll('th.sortable');
        const refreshBtn = document.getElementById('refreshBtn');
        const noteForm = document.getElementById('noteForm');
        const notesList = document.getElementById('notesList');

        let lastSortedColumn = null;
        let notes = [];

        // Optimized sort function (handles accordion rows)
        const sortTable = debounce(function (header) {
            const column = header.cellIndex;
            const tbody = table.querySelector('tbody');
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            const isAscending = header.classList.contains('asc');

            // Filter only main rows (not accordion collapse rows)
            const mainRows = allRows.filter(row => row.classList.contains('fund-row'));

            // Reset all headers
            headers.forEach(h => {
                h.classList.remove('asc', 'desc');
                h.querySelector('i').className = 'bi bi-arrow-down-up';
            });

            // Update current header
            header.classList.toggle('asc', !isAscending);
            header.classList.toggle('desc', isAscending);
            header.querySelector('i').className = isAscending ? 'bi bi-arrow-down' : 'bi bi-arrow-up';

            // Sort main rows with their associated accordion rows
            const sortedPairs = mainRows.map(mainRow => {
                const nextRow = mainRow.nextElementSibling;
                const accordionRow = (nextRow && nextRow.classList.contains('accordion-collapse')) ? nextRow : null;

                return {
                    mainRow: mainRow,
                    accordionRow: accordionRow,
                    value: parseFloat(mainRow.cells[column].getAttribute('data-value')) || 0
                };
            })
                .sort((a, b) => isAscending ? b.value - a.value : a.value - b.value);

            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            sortedPairs.forEach(pair => {
                fragment.appendChild(pair.mainRow);
                if (pair.accordionRow) {
                    fragment.appendChild(pair.accordionRow);
                }
            });
            tbody.appendChild(fragment);

            lastSortedColumn = header;
        }, 200);

        // Add click handlers
        headers.forEach(header => {
            header.addEventListener('click', () => sortTable(header));
        });

        // Refresh functionality
        refreshBtn.addEventListener('click', async () => {
            try {
                refreshBtn.classList.add('loading');
                const response = await fetch('/api/refresh');
                if (response.ok) {
                    // Reload the page to show fresh data
                    window.location.reload();
                } else {
                    console.error('Failed to refresh data');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            } finally {
                refreshBtn.classList.remove('loading');
            }
        });

        // Notes functionality
        async function renderNotes() {
            try {
                const response = await fetch('/api/notes');
                if (response.ok) {
                    notes = await response.json();
                    notesList.innerHTML = '';
                    notes.forEach((note, index) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <strong>${note.date}</strong>
                                <p class="mb-0">${note.text}</p>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="deleteNote(${index})">Delete</button>
                        `;
                        notesList.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Error fetching notes:', error);
            }
        }

        window.deleteNote = async function (index) {
            if (confirm('Are you sure you want to delete this note?')) {
                try {
                    const response = await fetch(`/api/notes/${index}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        renderNotes();
                    }
                } catch (error) {
                    console.error('Error deleting note:', error);
                }
            }
        };

        noteForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const date = document.getElementById('noteDate').value;
            const text = document.getElementById('noteText').value;

            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date, text })
                });

                if (response.ok) {
                    renderNotes();
                    noteForm.reset();
                    // Reset date to today
                    document.getElementById('noteDate').valueAsDate = new Date();
                }
            } catch (error) {
                console.error('Error saving note:', error);
            }
        });

        // Initialize notes
        renderNotes();
        document.getElementById('noteDate').valueAsDate = new Date();

        // View mode switching
        const comparisonViewContainer = document.getElementById('comparisonViewContainer');
        const expandCollapseButtons = document.getElementById('expandCollapseButtons');
        const tableViewRadio = document.getElementById('tableView');
        const comparisonViewRadio = document.getElementById('comparisonView');
        const tableViewContainer = document.getElementById('tableViewContainer');

        tableViewRadio.addEventListener('change', function () {
            if (this.checked) {
                tableViewContainer.style.display = 'block';
                comparisonViewContainer.style.display = 'none';
                expandCollapseButtons.style.display = 'block';
            }
        });

        comparisonViewRadio.addEventListener('change', function () {
            if (this.checked) {
                tableViewContainer.style.display = 'none';
                comparisonViewContainer.style.display = 'block';
                expandCollapseButtons.style.display = 'none';
            }
        });

        // Expand All functionality
        document.getElementById('expandAllBtn').addEventListener('click', function () {
            const collapseElements = document.querySelectorAll('.accordion-collapse');
            collapseElements.forEach(element => {
                const bsCollapse = new bootstrap.Collapse(element, { toggle: false });
                bsCollapse.show();
            });

            // Update all accordion icons
            const accordionRows = document.querySelectorAll('.accordion-button');
            accordionRows.forEach(row => {
                row.setAttribute('aria-expanded', 'true');
            });
        });

        // Collapse All functionality
        document.getElementById('collapseAllBtn').addEventListener('click', function () {
            const collapseElements = document.querySelectorAll('.accordion-collapse');
            collapseElements.forEach(element => {
                const bsCollapse = new bootstrap.Collapse(element, { toggle: false });
                bsCollapse.hide();
            });

            // Update all accordion icons
            const accordionRows = document.querySelectorAll('.accordion-button');
            accordionRows.forEach(row => {
                row.setAttribute('aria-expanded', 'false');
            });
        });

        // Generic table sorting function
        function setupTableSorting(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const headers = table.querySelectorAll('.sortable-header');

            headers.forEach(header => {
                header.addEventListener('click', function () {
                    const column = parseInt(this.getAttribute('data-column'));
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAscending = this.classList.contains('asc');

                    // Reset all headers
                    headers.forEach(h => {
                        h.classList.remove('asc', 'desc');
                        const icon = h.querySelector('i');
                        if (icon) icon.className = 'bi bi-arrow-down-up';
                    });

                    // Update current header
                    this.classList.toggle('asc', !isAscending);
                    this.classList.toggle('desc', isAscending);
                    const icon = this.querySelector('i');
                    if (icon) {
                        icon.className = isAscending ? 'bi bi-arrow-down' : 'bi bi-arrow-up';
                    }

                    // Sort rows
                    const sortedRows = rows.sort((a, b) => {
                        const aCell = a.cells[column];
                        const bCell = b.cells[column];

                        if (!aCell || !bCell) return 0;

                        // Use data-value attribute if available, otherwise use text content
                        let aValue = aCell.getAttribute('data-value') || aCell.textContent.trim();
                        let bValue = bCell.getAttribute('data-value') || bCell.textContent.trim();

                        // Try to parse as number
                        const aNum = parseFloat(aValue);
                        const bNum = parseFloat(bValue);

                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            // Numeric sorting
                            return isAscending ? bNum - aNum : aNum - bNum;
                        }

                        // Text sorting
                        return isAscending ?
                            bValue.toString().localeCompare(aValue.toString()) :
                            aValue.toString().localeCompare(bValue.toString());
                    });

                    // Re-append sorted rows
                    const fragment = document.createDocumentFragment();
                    sortedRows.forEach(row => fragment.appendChild(row));
                    tbody.appendChild(fragment);
                });
            });
        }

        // Setup sorting for all comparison tables
        setupTableSorting('shortTermTable');
        setupTableSorting('yearlyTable');
        setupTableSorting('summaryTable');

        // Dynamic year filtering and recalculation
        function recalculateReturns() {
            const selectedYears = Array.from(document.querySelectorAll('.year-filter:checked')).map(cb => parseInt(cb.value));

            if (selectedYears.length === 0) {
                alert('Please select at least one year');
                return;
            }

            // Recalculate for each fund row
            const summaryTable = document.getElementById('summaryTable');
            if (!summaryTable) return;

            const rows = summaryTable.querySelectorAll('tbody tr');

            rows.forEach(row => {
                // Get all cells with year data
                const abs2yCell = row.querySelector('.total-abs-2y');
                const cagr2yCell = row.querySelector('.cagr-2y');
                const abs3yCell = row.querySelector('.total-abs-3y');
                const cagr3yCell = row.querySelector('.cagr-3y');
                const abs5yCell = row.querySelector('.total-abs-5y');
                const cagr5yCell = row.querySelector('.cagr-5y');

                if (!abs5yCell) return;

                // Get individual year returns
                const yearReturns = {
                    1: parseFloat(abs5yCell.getAttribute('data-y1')) || 0,
                    2: parseFloat(abs5yCell.getAttribute('data-y2')) || 0,
                    3: parseFloat(abs5yCell.getAttribute('data-y3')) || 0,
                    4: parseFloat(abs5yCell.getAttribute('data-y4')) || 0,
                    5: parseFloat(abs5yCell.getAttribute('data-y5')) || 0
                };

                // Calculate based on selected years
                let totalMultiplier = 1;
                selectedYears.forEach(year => {
                    totalMultiplier *= (1 + yearReturns[year] / 100);
                });

                const totalAbsolute = (totalMultiplier - 1) * 100;
                const numYears = selectedYears.length;
                const cagr = numYears > 0 ? (Math.pow(totalMultiplier, 1 / numYears) - 1) * 100 : 0;

                // Update 5-year cells
                updateCell(abs5yCell, totalAbsolute);
                updateCell(cagr5yCell, cagr);

                // Calculate for 3-year period (Years 3, 4, 5)
                const years3 = selectedYears.filter(y => y >= 3);
                if (years3.length > 0) {
                    let mult3 = 1;
                    years3.forEach(y => mult3 *= (1 + yearReturns[y] / 100));
                    const abs3 = (mult3 - 1) * 100;
                    const cagr3 = Math.pow(mult3, 1 / years3.length) - 1;
                    updateCell(abs3yCell, abs3);
                    updateCell(cagr3yCell, cagr3 * 100);
                } else {
                    updateCellNA(abs3yCell);
                    updateCellNA(cagr3yCell);
                }

                // Calculate for 2-year period (Years 4, 5)
                const years2 = selectedYears.filter(y => y >= 4);
                if (years2.length > 0) {
                    let mult2 = 1;
                    years2.forEach(y => mult2 *= (1 + yearReturns[y] / 100));
                    const abs2 = (mult2 - 1) * 100;
                    const cagr2 = Math.pow(mult2, 1 / years2.length) - 1;
                    updateCell(abs2yCell, abs2);
                    updateCell(cagr2yCell, cagr2 * 100);
                } else {
                    updateCellNA(abs2yCell);
                    updateCellNA(cagr2yCell);
                }
            });
        }

        function updateCell(cell, value) {
            if (!cell) return;

            const span = cell.querySelector('span') || cell;
            const formattedValue = value.toFixed(2);

            // Update text
            if (span.tagName === 'SPAN') {
                span.textContent = formattedValue + '%';
                // Update color
                span.className = span.className.replace(/text-(success|danger)/, '');
                span.classList.add(value >= 0 ? 'text-success' : 'text-danger');
            } else {
                cell.textContent = formattedValue + '%';
            }

            // Update data-value for sorting
            cell.setAttribute('data-value', value);
        }

        function updateCellNA(cell) {
            if (!cell) return;

            const span = cell.querySelector('span') || cell;

            // Update text to N/A
            if (span.tagName === 'SPAN') {
                span.textContent = '—';
                // Set to muted color
                span.className = span.className.replace(/text-(success|danger|secondary)/, 'text-muted');
            } else {
                cell.textContent = '—';
            }

            // Update data-value for sorting
            cell.setAttribute('data-value', '0');
        }

        // Event listeners for year filters
        document.querySelectorAll('.year-filter').forEach(checkbox => {
            checkbox.addEventListener('change', recalculateReturns);
        });

        // Reset all years
        document.getElementById('resetYearsBtn').addEventListener('click', function () {
            document.querySelectorAll('.year-filter').forEach(cb => cb.checked = true);
            recalculateReturns();
        });
    </script>
</body>

</html>